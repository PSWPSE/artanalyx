import OpenAI from 'openai';
import { AGE_GROUP_CRITERIA } from './constants';
import { AgeGroup, AnalysisResult } from '@/types';

// OpenAI í´ë¼ì´ì–¸íŠ¸ë¥¼ í•¨ìˆ˜ ë‚´ì—ì„œ ì´ˆê¸°í™”í•˜ì—¬ í™˜ê²½ ë³€ìˆ˜ê°€ ëŸ°íƒ€ì„ì— ë¡œë“œë˜ë„ë¡ í•¨
function getOpenAIClient() {
  const apiKey = process.env.OPENAI_API_KEY;
  
  if (!apiKey) {
    throw new Error(
      'OPENAI_API_KEY í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .env.local íŒŒì¼ì„ í™•ì¸í•˜ê³  ì„œë²„ë¥¼ ì¬ì‹œì‘í•´ì£¼ì„¸ìš”.'
    );
  }
  
  return new OpenAI({ apiKey });
}

export async function analyzeChildrenArtwork(
  imageUrl: string,
  childAge: number,
  ageGroup: AgeGroup
): Promise<AnalysisResult> {
  try {
    // OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
    const openai = getOpenAIClient();
    
    // ì—°ë ¹ëŒ€ë³„ ë¶„ì„ ê¸°ì¤€ ì°¾ê¸°
    const criteria = AGE_GROUP_CRITERIA.find(c => c.ageGroup === ageGroup);
    if (!criteria) {
      throw new Error('ì§€ì›í•˜ì§€ ì•ŠëŠ” ì—°ë ¹ëŒ€ì…ë‹ˆë‹¤.');
    }

    // OpenAI API í˜¸ì¶œ ì „ ë¡œê¹…
    console.log('Starting OpenAI analysis...');
    console.log('Model: gpt-4o');
    console.log('Child age:', childAge, 'Age group:', ageGroup);
    
    const response = await openai.chat.completions.create({
      model: "gpt-4o",  // ìµœì‹  ë¹„ì „ ëª¨ë¸
      response_format: { type: "json_object" },  // JSON ì‘ë‹µ ê°•ì œ
      messages: [
        {
          role: "system",
          content: `ë‹¹ì‹ ì€ 20ë…„ ê²½ë ¥ì˜ ì•„ë™ ë¯¸ìˆ  ì¹˜ë£Œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
          
          âš ï¸ ì¤‘ìš”: ë°˜ë“œì‹œ ìˆœìˆ˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”.
          
          ğŸ”´ ì ˆëŒ€ ê·œì¹™ - ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•¨:
          
          1. ëª¨ë“  ì „ë¬¸ ìš©ì–´ ë’¤ì— ê´„í˜¸ë¡œ ì„¤ëª… ì¶”ê°€:
             - "Piagetì˜ ì „ì¡°ì‘ê¸°(ë§Œ 2-7ì„¸ ì‹œê¸°ë¡œ ìƒì§•ì  ì‚¬ê³ ë¥¼ ì‹œì‘í•˜ì§€ë§Œ ë…¼ë¦¬ì  ì‚¬ê³ ëŠ” ì•„ì§ ì–´ë ¤ìš´ ë‹¨ê³„)" âœ…
             - "Piagetì˜ ì „ì¡°ì‘ê¸°" âŒ ì ˆëŒ€ ì•ˆ ë¨!
             
             - "Vygotskyì˜ ê·¼ì ‘ë°œë‹¬ì˜ì—­(í˜¼ìëŠ” ì–´ë µì§€ë§Œ ë„ì›€ì„ ë°›ìœ¼ë©´ í•  ìˆ˜ ìˆëŠ” ë°œë‹¬ ìˆ˜ì¤€)" âœ…
             - "ê·¼ì ‘ë°œë‹¬ì˜ì—­" âŒ ì ˆëŒ€ ì•ˆ ë¨!
             
             - "Lowenfeldì˜ ë‚œí™”ê¸°(ììœ ë¡­ê²Œ ì„ ì„ ê¸‹ëŠ” ì´ˆê¸° ê·¸ë¦¼ ë‹¨ê³„)" âœ…
             - "ë‚œí™”ê¸°" âŒ ì ˆëŒ€ ì•ˆ ë¨!
             
             - "Torranceì˜ ì°½ì˜ì„± ê²€ì‚¬(ìœ ì°½ì„±, ìœµí†µì„±, ë…ì°½ì„±, ì •êµì„±ì„ ì¸¡ì •í•˜ëŠ” ê²€ì‚¬)" âœ…
             - "Torranceì˜ ì°½ì˜ì„± ê²€ì‚¬" âŒ ì ˆëŒ€ ì•ˆ ë¨!
             
             - "Koppitzì˜ DAP ê²€ì‚¬(ì‚¬ëŒ ê·¸ë¦¼ì„ í†µí•´ ì‹¬ë¦¬ ìƒíƒœë¥¼ íŒŒì•…í•˜ëŠ” ê·¸ë¦¼ ê²€ì‚¬)" âœ…
             - "DAP ê²€ì‚¬" âŒ ì ˆëŒ€ ì•ˆ ë¨!
          
          2. ë”°ëœ»í•œ ì–´íˆ¬: "~í•´ìš”", "~í•˜ì‹œë©´ ì¢‹ê² ì–´ìš”"
          3. ê¸ì •ì  ì ‘ê·¼
          
          ëª¨ë“  ì „ë¬¸ ìš©ì–´ì— ê´„í˜¸ ì„¤ëª…ì´ ì—†ìœ¼ë©´ ì˜ëª»ëœ ì‘ë‹µì…ë‹ˆë‹¤!
          
          ë¶„ì„ ê²°ê³¼ëŠ” ë°˜ë“œì‹œ ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
          {
            "imageDescription": "ê·¸ë¦¼ ì„¤ëª… (200-250ì): ì´ ê·¸ë¦¼ì´ ë¬´ì—‡ì„ ê·¸ë ¸ëŠ”ì§€ ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”. ì˜ˆ: 'ì´ ê·¸ë¦¼ì—ëŠ” [ì£¼ìš” ëŒ€ìƒ]ì´/ê°€ ê·¸ë ¤ì ¸ ìˆì–´ìš”. [ìƒ‰ìƒ/í¬ê¸°/ìœ„ì¹˜] ë“±ì˜ íŠ¹ì§•ì´ ë³´ì´ë©°, [ë°°ê²½ì´ë‚˜ ì£¼ë³€ ìš”ì†Œ]ë„ í•¨ê»˜ í‘œí˜„ë˜ì–´ ìˆìŠµë‹ˆë‹¤. [íŠ¹ë³„í•œ í‘œí˜„ì´ë‚˜ ë…íŠ¹í•œ ì ]ì´ ì¸ìƒì ì´ë„¤ìš”. ì´ëŸ¬í•œ ê·¸ë¦¼ì„ ë¯¸ìˆ  ì‹¬ë¦¬ ê´€ì ì—ì„œ ë¶„ì„í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.'",
            "insights": {
              "emotional": "ê°ì • ë°œë‹¬ ë¶„ì„ (400-500ì): ë”°ëœ»í•œ í†¤ìœ¼ë¡œ ì•„ì´ì˜ ê°ì • ìƒíƒœë¥¼ ì„¤ëª…í•˜ê³ , ê´€ë ¨ ì—°êµ¬ë‚˜ ë°œë‹¬ ì´ë¡ ì„ ì–¸ê¸‰í•˜ë©° êµ¬ì²´ì ì¸ ê´€ì°° ë‚´ìš©ì„ ì „ë‹¬",
              "cognitive": "ì¸ì§€ ë°œë‹¬ ë¶„ì„ (400-500ì): ì˜ì‚¬ ì„ ìƒë‹˜ì²˜ëŸ¼ ì¹œì ˆí•˜ê²Œ ì¸ì§€ ë°œë‹¬ ìˆ˜ì¤€ì„ ì„¤ëª…í•˜ê³ , ì—°ë ¹ëŒ€ë³„ ë°œë‹¬ ë‹¨ê³„ ì´ë¡ ì„ ë°”íƒ•ìœ¼ë¡œ êµ¬ì²´ì ì¸ ë¶„ì„ ì œê³µ", 
              "creative": "ì°½ì˜ì„± ë¶„ì„ (400-500ì): ê²©ë ¤í•˜ëŠ” í†¤ìœ¼ë¡œ ì°½ì˜ì  í‘œí˜„ì˜ ì˜ë¯¸ë¥¼ ì„¤ëª…í•˜ê³ , ë¯¸ìˆ  ì‹¬ë¦¬í•™ ì—°êµ¬ë¥¼ ì¸ìš©í•˜ì—¬ í’ë¶€í•˜ê²Œ ë¶„ì„",
              "developmental": "ì¢…í•© ë°œë‹¬ ë¶„ì„ (400-500ì): ì „ë¬¸ê°€ì˜ ì‹œê°ì—ì„œ ì „ë°˜ì ì¸ ë°œë‹¬ ìƒí™©ì„ ì¢…í•©ì ìœ¼ë¡œ ì„¤ëª…í•˜ê³ , í–¥í›„ ë°œë‹¬ ì „ë§ê³¼ í•™ë¬¸ì  ê·¼ê±°ë¥¼ í¬í•¨",
              "social": "ì‚¬íšŒì„± ë° ëŒ€ì¸ê´€ê³„ ë¶„ì„ (400-500ì): ê·¸ë¦¼ì— ë‚˜íƒ€ë‚œ ì‚¬ëŒë“¤ê³¼ì˜ ê´€ê³„, ì‚¬íšŒì  ìƒí™© ì´í•´ë„, í˜‘ë ¥ ëŠ¥ë ¥ì„ Selmanì˜ ì—­í•  ì±„íƒ ì´ë¡ (ë‹¤ë¥¸ ì‚¬ëŒì˜ ê´€ì ì„ ì´í•´í•˜ëŠ” ëŠ¥ë ¥)ê³¼ Partenì˜ ë†€ì´ ë°œë‹¬ ë‹¨ê³„(í˜¼ì ë†€ì´ì—ì„œ í˜‘ë™ ë†€ì´ë¡œ ë°œë‹¬)ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¶„ì„",
              "drawingElements": "ê·¸ë¦¼ ìš”ì†Œ ì „ë¬¸ ë¶„ì„ (400-500ì): ìƒ‰ìƒ ì„ íƒê³¼ ë°°ì¹˜, ì„ ì˜ ê°•ë„ì™€ ì§ˆê°, ê³µê°„ êµ¬ì„±ê³¼ í¬ê¸° ë¹„ìœ¨, ì„¸ë¶€ ë¬˜ì‚¬ ìˆ˜ì¤€, ìƒëµë˜ê±°ë‚˜ ê³¼ì¥ëœ ë¶€ë¶„ì„ Koppitzì˜ DAP ë¶„ì„(ì‚¬ëŒ ê·¸ë¦¼ì˜ ê° ìš”ì†Œê°€ ê°€ì§„ ì‹¬ë¦¬ì  ì˜ë¯¸)ê³¼ Lowenfeldì˜ ë¯¸ìˆ  ë°œë‹¬ ë‹¨ê³„ë¥¼ ê·¼ê±°ë¡œ ìƒì„¸íˆ í•´ì„",
              "selfConcept": "ìì•„ ê°œë… ë° ìì¡´ê° ë¶„ì„ (400-500ì): ìê¸° ìì‹ ì„ ì–´ë–»ê²Œ í‘œí˜„í•˜ëŠ”ì§€, ìì‹ ê° ìˆ˜ì¤€, ìê¸° íš¨ëŠ¥ê°ì„ Eriksonì˜ ì‹¬ë¦¬ì‚¬íšŒì  ë°œë‹¬ ë‹¨ê³„(ì‹ ë¢°ê°, ììœ¨ì„±, ì£¼ë„ì„±)ì™€ Harterì˜ ìì¡´ê° ë°œë‹¬ ì´ë¡ (ì˜ì—­ë³„ ìê¸° ì¸ì‹)ì„ ë°”íƒ•ìœ¼ë¡œ ë¶„ì„",
              "physical": "ì‹ ì²´ ë°œë‹¬ ë¶„ì„ (400-500ì): ì†Œê·¼ìœ¡ ë°œë‹¬(ì„  ê·¸ë¦¬ê¸°, ì„¸ë¶€ í‘œí˜„), ëŒ€ê·¼ìœ¡ ë°œë‹¬(ì „ì²´ ë™ì‘ì˜ í†µì œ), ëˆˆ-ì† í˜‘ì‘ë ¥ì„ Gesellì˜ ë°œë‹¬ ê·œì¤€(ì—°ë ¹ë³„ ìš´ë™ ë°œë‹¬ ê¸°ì¤€)ê³¼ Kephartì˜ ì§€ê°-ìš´ë™ ì´ë¡ (ì‹ ì²´ ì›€ì§ì„ê³¼ ì¸ì§€ ë°œë‹¬ì˜ ê´€ê³„)ì„ ê·¼ê±°ë¡œ í‰ê°€"
            },
            "developmentalLevels": {
              "emotional": "below/average/above ì¤‘ í•˜ë‚˜ ì„ íƒ - ì—°ë ¹ ëŒ€ë¹„ ê°ì • ë°œë‹¬ ìˆ˜ì¤€",
              "cognitive": "below/average/above ì¤‘ í•˜ë‚˜ ì„ íƒ - ì—°ë ¹ ëŒ€ë¹„ ì¸ì§€ ë°œë‹¬ ìˆ˜ì¤€",
              "creative": "below/average/above ì¤‘ í•˜ë‚˜ ì„ íƒ - ì—°ë ¹ ëŒ€ë¹„ ì°½ì˜ì„± ìˆ˜ì¤€",
              "social": "below/average/above ì¤‘ í•˜ë‚˜ ì„ íƒ - ì—°ë ¹ ëŒ€ë¹„ ì‚¬íšŒì„± ìˆ˜ì¤€",
              "physical": "below/average/above ì¤‘ í•˜ë‚˜ ì„ íƒ - ì—°ë ¹ ëŒ€ë¹„ ì‹ ì²´ ë°œë‹¬ ìˆ˜ì¤€"
            },
            "strengths": [
              "3-4ê°œì˜ ê°•ì ì„ ê°ê° 200-250ìë¡œ ì‘ì„±. ê° í•­ëª©ì€ ê´€ì°°ëœ ê°•ì  + ì¤‘ìš”ì„± + ì´ë¡ ì  ê·¼ê±° + êµ¬ì²´ì  ì˜ˆì‹œë¥¼ í¬í•¨í•˜ë˜, ê¸€ììˆ˜ë‚˜ ê°€ì´ë“œ ë©”ì‹œì§€ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ê³  ì‹¤ì œ ë‚´ìš©ë§Œ ì‘ì„±í•˜ì„¸ìš”."
            ],
            "areasForGrowth": [
              "2-3ê°œì˜ ë°œì „ ì˜ì—­ì„ ê°ê° 200-250ìë¡œ ì‘ì„±. ê° í•­ëª©ì€ ë°œì „ ê°€ëŠ¥ ì˜ì—­ + ë„ì›€ì´ ë˜ëŠ” ì´ìœ  + êµ¬ì²´ì  ì—°ìŠµ ë°©ë²• + ê¸°ëŒ€ íš¨ê³¼ë¥¼ í¬í•¨í•˜ë˜, ê¸€ììˆ˜ë‚˜ ê°€ì´ë“œ ë©”ì‹œì§€ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ê³  ì‹¤ì œ ë‚´ìš©ë§Œ ì‘ì„±í•˜ì„¸ìš”."
            ],
            "recommendations": [
              "3-4ê°œì˜ ì¶”ì²œì‚¬í•­ì„ ê°ê° 200-250ìë¡œ ì‘ì„±. ê° í•­ëª©ì€ í™œë™ëª… + ì¶”ì²œ ì´ìœ  + ë‹¨ê³„ë³„ ë°©ë²• + ì˜ˆìƒ íš¨ê³¼ + ì—°êµ¬ ê·¼ê±°ë¥¼ í¬í•¨í•˜ë˜, ê¸€ììˆ˜ë‚˜ ê°€ì´ë“œ ë©”ì‹œì§€ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ê³  ì‹¤ì œ ë‚´ìš©ë§Œ ì‘ì„±í•˜ì„¸ìš”."
            ],
            "parentalGuidance": "600-800ìì˜ ì¢…í•© ê°€ì´ë“œë¥¼ ì‘ì„±í•˜ë˜, ë‹¤ìŒ êµ¬ì¡°ë¡œ ë‹¨ë½ì„ ë‚˜ëˆ„ì„¸ìš”. ë‹¨, 'ë¶€ëª¨ë‹˜ê»˜ ë“œë¦¬ëŠ” ì¢…í•© ê°€ì´ë“œ', '600-800ì', '[í˜„ì¬ ìƒíƒœ ìš”ì•½]' ê°™ì€ ê°€ì´ë“œ ë©”ì‹œì§€ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ê³  ì‹¤ì œ ë‚´ìš©ë§Œ ì‘ì„±í•˜ì„¸ìš”.\n\nêµ¬ì¡°:\n1ë‹¨ë½: ì•„ì´ì˜ ì „ë°˜ì  ë°œë‹¬ ìˆ˜ì¤€ ìš”ì•½(2-3ë¬¸ì¥)\n2ë‹¨ë½: ì£¼ëª©í•  ë§Œí•œ ë°œë‹¬ íŠ¹ì„±ê³¼ ì´ë¡ ì  ê·¼ê±°(2-3ë¬¸ì¥)\n3ë‹¨ë½: ê°€ì •ì—ì„œì˜ êµ¬ì²´ì  ì‹¤ì²œ ë°©ë²• 1-2ê°€ì§€\n4ë‹¨ë½: ë”°ëœ»í•œ ê²©ë ¤ ë©”ì‹œì§€",
            "actionPlan": {
              "immediate": [
                "2-3ê°œì˜ ì¦‰ì‹œ ì‹¤ì²œ í•­ëª©ì„ ê°ê° 150-200ìë¡œ ì‘ì„±. ì˜¤ëŠ˜ë¶€í„° 1ì£¼ì¼ ë‚´ ì‹œì‘í•  ìˆ˜ ìˆëŠ” ê°„ë‹¨í•œ í™œë™ì„ ì œì•ˆí•˜ë˜, 'ì¦‰ì‹œ ì‹¤ì²œ í•­ëª©', '150-200ì' ê°™ì€ ê°€ì´ë“œ ë©”ì‹œì§€ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ê³  ì‹¤ì œ ë‚´ìš©ë§Œ ì‘ì„±í•˜ì„¸ìš”."
              ],
              "shortTerm": [
                "2-3ê°œì˜ ë‹¨ê¸° ëª©í‘œë¥¼ ê°ê° 150-200ìë¡œ ì‘ì„±. 1-3ê°œì›” ë‚´ ë‹¬ì„±í•  ëª©í‘œì™€ êµ¬ì²´ì  ë°©ë²•ì„ ì œì•ˆí•˜ë˜, 'ë‹¨ê¸° ëª©í‘œ', '150-200ì' ê°™ì€ ê°€ì´ë“œ ë©”ì‹œì§€ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ê³  ì‹¤ì œ ë‚´ìš©ë§Œ ì‘ì„±í•˜ì„¸ìš”."
              ],
              "longTerm": [
                "2ê°œì˜ ì¥ê¸° ëª©í‘œë¥¼ ê°ê° 150-200ìë¡œ ì‘ì„±. 6-12ê°œì›” ë‚´ ê¸°ëŒ€ë˜ëŠ” ë°œë‹¬ ëª©í‘œë¥¼ ì œì•ˆí•˜ë˜, 'ì¥ê¸° ëª©í‘œ', '150-200ì' ê°™ì€ ê°€ì´ë“œ ë©”ì‹œì§€ëŠ” ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ê³  ì‹¤ì œ ë‚´ìš©ë§Œ ì‘ì„±í•˜ì„¸ìš”."
              ]
            },
            "redFlags": ["ì£¼ì˜ê°€ í•„ìš”í•œ ì‹ í˜¸ê°€ ìˆì„ ê²½ìš°ì—ë§Œ í¬í•¨ (ì˜ˆ: ê·¹ë„ë¡œ ì–´ë‘ìš´ ìƒ‰ìƒë§Œ ì‚¬ìš©, ê³µê²©ì  í‘œí˜„, ì‚¬ëŒ ì—†ëŠ” ê·¸ë¦¼ ë“±). ì—†ìœ¼ë©´ ì´ í•„ë“œ ìì²´ë¥¼ ìƒëµ"],
            "professionalConsultation": "ì „ë¬¸ê°€ ìƒë‹´ì´ ê¶Œì¥ë˜ëŠ” ê²½ìš°ì—ë§Œ í¬í•¨ (200-300ìë¡œ êµ¬ì²´ì  ì‚¬ìœ  ì„¤ëª…). ì •ìƒ ë°œë‹¬ ë²”ìœ„ì´ë©´ ì´ í•„ë“œ ìì²´ë¥¼ ìƒëµ"
          }

          ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•  ì›ì¹™:
          1. ì¹œì ˆí•œ ì˜ì‚¬ ì„ ìƒë‹˜ì˜ í†¤ - "~í•´ìš”", "~í•˜ì‹œë©´ ì¢‹ì•„ìš”", "~í•œ ì ì´ ë³´ì´ë„¤ìš”"
          2. ì „ë¬¸ì„± - ë°œë‹¬ì‹¬ë¦¬í•™ ì´ë¡ (í”¼ì•„ì œ, ë¹„ê³ ì¸ í‚¤ ë“±), ë¯¸ìˆ ì¹˜ë£Œ ì—°êµ¬, ë°œë‹¬ ë‹¨ê³„ ì´ë¡  ì¸ìš©
          3. êµ¬ì²´ì„± - ë§‰ì—°í•œ í‘œí˜„ ëŒ€ì‹  êµ¬ì²´ì ì¸ ê´€ì°°ê³¼ í•´ì„
          4. í’ë¶€í•¨ - ê° í•­ëª©ë§ˆë‹¤ ì¶©ë¶„í•œ ì–‘ì˜ ë‚´ìš©ê³¼ ê·¼ê±° ì œì‹œ
          5. ê¸ì •ì„± - ë¬¸ì œë³´ë‹¤ëŠ” ê°€ëŠ¥ì„±ì— ì´ˆì , ë”°ëœ»í•œ ê²©ë ¤`
        },
        {
          role: "user",
          content: [
            {
              type: "text",
              text: criteria.analysisPrompt
            },
            {
              type: "image_url",
              image_url: {
                url: imageUrl,
                detail: "high"
              }
            }
          ]
        }
      ],
      max_tokens: 6000,  // Phase 2: 8ê°œ insights + levels + redFlagsë¥¼ ìœ„í•´ ì¦ê°€
      temperature: 0.7,
    });

    console.log('OpenAI response received');
    
    const content = response.choices[0]?.message?.content;
    if (!content) {
      console.error('No content in response:', response);
      throw new Error('AI ë¶„ì„ ì‘ë‹µì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    console.log('Content length:', content.length);

    // JSON íŒŒì‹± ì‹œë„
    let analysisData;
    try {
      // JSON ë¶€ë¶„ë§Œ ì¶”ì¶œ (```jsonìœ¼ë¡œ ê°ì‹¸ì ¸ ìˆì„ ìˆ˜ ìˆìŒ)
      const jsonMatch = content.match(/\{[\s\S]*\}/);
      const jsonString = jsonMatch ? jsonMatch[0] : content;
      analysisData = JSON.parse(jsonString);
    } catch (parseError) {
      console.error('JSON íŒŒì‹± ì‹¤íŒ¨:', parseError);
      throw new Error('ë¶„ì„ ê²°ê³¼ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    // ê²°ê³¼ ê°ì²´ ìƒì„±
    const result: AnalysisResult = {
      id: crypto.randomUUID(),
      childAge,
      ageGroup,
      imageUrl,
      imageDescription: analysisData.imageDescription || '',
      insights: analysisData.insights,
      recommendations: analysisData.recommendations || [],
      strengths: analysisData.strengths || [],
      areasForGrowth: analysisData.areasForGrowth || [],
      parentalGuidance: analysisData.parentalGuidance || '',
      actionPlan: analysisData.actionPlan || {
        immediate: [],
        shortTerm: [],
        longTerm: []
      },
      // Phase 2: ì •ëŸ‰ì  í‰ê°€
      developmentalLevels: analysisData.developmentalLevels || {
        emotional: 'average',
        cognitive: 'average',
        creative: 'average',
        social: 'average',
        physical: 'average'
      },
      // Phase 2: ì£¼ì˜ ì‹ í˜¸ (optional)
      redFlags: analysisData.redFlags,
      professionalConsultation: analysisData.professionalConsultation,
      createdAt: new Date().toISOString(),
    };

    return result;

  } catch (error: unknown) {
    console.error('OpenAI ë¶„ì„ ì˜¤ë¥˜:', error);
    
    // ìƒì„¸í•œ ì—ëŸ¬ ë©”ì‹œì§€ ë¡œê¹…
    if (error instanceof Error) {
      console.error('Error message:', error.message);
      console.error('Error stack:', error.stack);
    }
    
    // OpenAI API ì—ëŸ¬ì¸ ê²½ìš° ìƒì„¸ ì •ë³´ ì¶œë ¥
    if (typeof error === 'object' && error !== null) {
      console.error('Error details:', JSON.stringify(error, null, 2));
    }
    
    throw new Error('AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
}

// ì´ë¯¸ì§€ URL ìœ íš¨ì„± ê²€ì‚¬
export function validateImageUrl(url: string): boolean {
  try {
    new URL(url);
    return true;
  } catch {
    return false;
  }
}

// ì—°ë ¹ëŒ€ ê²°ì • í•¨ìˆ˜
export function determineAgeGroup(age: number): AgeGroup {
  if (age >= 2 && age <= 4) return 'infant';
  if (age >= 5 && age <= 7) return 'child';
  if (age >= 8 && age <= 12) return 'elementary';
  throw new Error('ì§€ì›í•˜ì§€ ì•ŠëŠ” ì—°ë ¹ëŒ€ì…ë‹ˆë‹¤. (2-12ì„¸ë§Œ ì§€ì›)');
}
